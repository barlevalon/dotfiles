#!/bin/bash

font_name="$1"

if [[ -n "$font_name" && "$font_name" != "CNCLD" ]]; then
  if fc-list | grep -iq "$font_name"; then
    # Update Ghostty if config exists
    if [[ -f ~/.config/ghostty/config ]]; then
      sed -i "s/^font-family = .*/font-family = $font_name/g" ~/.config/ghostty/config
      echo "✓ Updated Ghostty font"
    fi
    
    # Update Waybar
    if [[ -f ~/.config/waybar/style.css ]]; then
      sed -i "s/font-family: .*/font-family: $font_name;/g" ~/.config/waybar/style.css
      echo "✓ Updated Waybar font"
    fi
    
    # Update SwayOSD
    if [[ -f ~/.config/swayosd/style.css ]]; then
      sed -i "s/font-family: .*/font-family: '$font_name', monospace;/g" ~/.config/swayosd/style.css
      echo "✓ Updated SwayOSD font"
    fi
    
    # Update Walker theme
    if [[ -f ~/.config/walker/themes/main.css ]]; then
      sed -i "s/font-family: .*/font-family: '$font_name', monospace;/g" ~/.config/walker/themes/main.css
      echo "✓ Updated Walker font"
    fi
    
    # Update Wofi
    if [[ -f ~/.config/wofi/style.css ]]; then
      sed -i "s/font-family: .*/font-family: '$font_name', monospace;/g" ~/.config/wofi/style.css
      echo "✓ Updated Wofi font"
    fi
    
    # Update fontconfig for monospace
    if [[ -f ~/.config/fontconfig/fonts.conf ]]; then
      if command -v xmlstarlet &> /dev/null; then
        xmlstarlet ed -L \
          -u '//match[@target="pattern"][test/string="monospace"]/edit[@name="family"]/string' \
          -v "$font_name" \
          ~/.config/fontconfig/fonts.conf 2>/dev/null
        echo "✓ Updated fontconfig"
      fi
    fi
    
    # Restart services if they're running
    if pgrep waybar > /dev/null; then
      pkill -SIGUSR2 waybar
      echo "✓ Reloaded Waybar"
    fi
    
    if pgrep swayosd-server > /dev/null; then
      systemctl --user restart swayosd-server.service 2>/dev/null || pkill swayosd-server
      echo "✓ Restarted SwayOSD"
    fi
    
    echo "Font set to: $font_name"
  else
    echo "Font '$font_name' not found in system."
    echo "Available monospace fonts:"
    fc-list :mono family | sort -u | head -20
    exit 1
  fi
else
  echo "Usage: font-set <font-name>"
  echo "Example: font-set 'MesloLGM Nerd Font'"
fi