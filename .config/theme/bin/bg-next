#!/bin/bash
set -euo pipefail

# bg-next: Cycle through backgrounds for the current theme
# Usage: bg-next

THEME_BASE_DIR="$HOME/.config/theme"
CURRENT_THEME=$(cat "$THEME_BASE_DIR/current_theme" 2>/dev/null || echo "nord")
BG_DIR="$THEME_BASE_DIR/backgrounds/$CURRENT_THEME"
CURRENT_BG_LINK="$THEME_BASE_DIR/background.jpg"

# Check if background directory exists
if [[ ! -d "$BG_DIR" ]]; then
  echo "No backgrounds found for theme: $CURRENT_THEME" >&2
  exit 1
fi

# Get all background images
mapfile -t backgrounds < <(find "$BG_DIR" -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" -o -name "*.webp" \) | sort)

# Check if any backgrounds exist
if [[ ${#backgrounds[@]} -eq 0 ]]; then
  echo "No background images found in: $BG_DIR" >&2
  exit 1
fi

# Get current background
current_bg=""
if [[ -L "$CURRENT_BG_LINK" ]]; then
  current_bg=$(readlink -f "$CURRENT_BG_LINK")
fi

# Find next background
next_index=0
for i in "${!backgrounds[@]}"; do
  if [[ "${backgrounds[$i]}" == "$current_bg" ]]; then
    next_index=$(( (i + 1) % ${#backgrounds[@]} ))
    break
  fi
done

# Set next background
next_bg="${backgrounds[$next_index]}"
ln -nsf "$next_bg" "$CURRENT_BG_LINK"

# Update swaybg
pkill -x swaybg 2>/dev/null || true
uwsm app -- swaybg -i "$next_bg" -m fill >/dev/null 2>&1 &

echo "Background changed to: $(basename "$next_bg")"